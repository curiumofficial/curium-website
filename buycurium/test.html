<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Phore Staking Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.min.js"></script>
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.39/css/uikit.min.css"/>
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">
    <!-- UIkit JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.39/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.39/js/uikit-icons.min.js"></script>
    <style>
        html {
            background-color: #f9f9f9;
        }
        #app{
            padding:1em;
            font-family: 'Varela Round', sans-serif;
        }
        .info {
            font-size: 12px;
        }
        .green {
            color: #006600;
        }
        .uk-form-label{
            font-weight: 600;
        }
    </style>
	<script>
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var myObj = JSON.parse(this.responseText);						
				<!-- for(var j = 0; j < myObj.curium.length; j++){ -->
				document.getElementById('totalStaking').value = myObj.data[0][0];
			}
		};
		xmlhttp.open("GET", "num.json", true);
		xmlhttp.send();	
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var myObj = JSON.parse(this.responseText);						
				<!-- for(var j = 0; j < myObj.curium.length; j++){ -->
				document.getElementById('totalStaking').innerHTML = myObj.data[0][0];
			}
		};
		xmlhttp.open("GET", "num.json", true);
		xmlhttp.send();			
		
	</script>
</head>
<body>
        <div id="wrap">

            <article id="content">
                <table>
                    <tr>
                        <td><label id="entry_coins">Number Of Coins</label></td>
                        <td><input type="number" id="NumberOfCoinsStart" value="1000" onBlur="return is_int(this)"></td>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td><label id="entry_days">Age of transaction (days)</label></td>
                        <td><input type="number" id="AgeOfTransaction" value="31"></td>
                        <td style="color:red;font-size:80%" id="AgeOfTransaction_error">Probability maxed at 90 days</td>
                    </tr>
                    <tr>
                        <td><label id="entry_difficulty">POS difficulty</label></td>
                        <td><input type="number" id="POSDifficulty" value="10"></td>
                        <td>&nbsp;</td>
                    </tr>
                </table>
                <br>
                <table class=result>
                    <tr>
                        <th><label id="prob_mint">Minting POS block within</label></th>
                        <th><label id="prob_10m">10 min</label></th>
                        <th><label id="prob_24h">24 hours</label></th>
                        <th><label id="prob_31d">31 days</label></th>
                        <th><label id="prob_90d">90 days</label></th>
                        <th><label id="prob_1y">1 year</label></th>
                    </tr>
                    <tr>
                        <th><label id="prob_prob">Probability</label></th>
                        <td class=num><label id="probBlockToday"></label></td>
                        <td class=num><label id="probBlock7d"></label></td>
                        <td class=num><label id="probBlock31d"></label></td>
                        <td class=num><label id="probBlock90d"></label></td>
                        <td class=num><label id="probBlockYear"></label></td>
                    </tr>
                    <tr>
                        <th><label id="reward_block">Reward</label></td>
                        <td class=num><label id="rewardNextToday"></label></td>
                        <td class=num><label id="rewardBlock7d"></label></td>
                        <td class=num><label id="rewardBlock31d"></label></td>
                        <td class=num><label id="rewardBlock90d"></label></td>
                        <td class=num><label id="rewardBlockYear"></label></td>
                    </tr>
                </table>
                <br>
            </article>
            <footer>
                <a id="footer_peer4commit" href="http://peer4commit.com/projects/5" target="_blank">Donate to the development of this project</a>
                <a id="footer_peercointalk" href="http://donate.peercointalk.org/" target="_blank">Donate to Peercointalk projects</a>
                <a id="footer_github" href="https://github.com/FuzzyBearBTC/peercoin-POSCalculator" target="_blank">Contribute to this project on GitHub</a>
            </footer>
        </div>
        <noscript>
            <section id=noscript>
                <p>Peercoin POS Calculator requires JavaScript. Please enable it in your browser and refresh.
            </section>
        </noscript>
</body>

        <script>
            var is_int = function(value) {
                return ((parseFloat(value) === parseInt(value)) && !isNaN(value));
            };
            var toFixed = function(value, precision) {
                precision = (precision || 0);
                var neg = (value < 0);
                var power = Math.pow(10, precision);
                value = Math.round(value * power);
                var integral = String((neg ? Math.ceil : Math.floor)(value / power));
                var fraction = String((neg ? -value : value) % power);
                var padding = new Array(Math.max(precision - fraction.length, 0) + 1).join('0');
                var res = precision ? (integral + '.' +  padding + fraction) : integral;
                return res;
            };
            var calculateProbStake = function(days, coins, difficulty) {
                var prob = 0;
                if (days > 30) {
                    var maxTarget = Math.pow(2, 224);
                    var target = maxTarget / difficulty;
                    var dayWeight = Math.min(days, 90) - 30;
                    prob = (target * coins * dayWeight) / Math.pow(2, 256);
                }
                return prob;
            };
            var calculateProbBlockToday = function(days, coins, difficulty) {
                var prob = calculateProbStake(days, coins, difficulty);
                var res = 1 - Math.pow(1 - prob, 60 * 10 * 6 * 24);
                return res;
            };
            var calculateProbBlockNDays = function(days, coins, difficulty, n) {
                var prob = 1;
                var p = 0;
                for (var i = 0; i < n; i++) {
                    p = calculateProbBlockToday(parseFloat(days) + i, coins, difficulty);
                    prob = prob * (1 - p);
                }
                prob = 1 - prob;
                return prob;
            };
            var calculateReward = function(days, coins) {
                var res = 0;
                if (days > 30) {
                    res = 0.01 * (days * coins * 33) / (365 * 33 + 8);
                }
                return toFixed(res, 2);
            };
            var run = function() {
                var coinValue = document.getElementById('NumberOfCoinsStart').value;
                var Days = document.getElementById('AgeOfTransaction').value;
                var difficulty = document.getElementById('POSDifficulty').value;
                if (Days > 90) {
                    $('#AgeOfTransaction_error').show();
                }
                else {
                    $('#AgeOfTransaction_error').hide();
                }
                // Minting probabilities
                var probBlockToday = calculateProbBlockToday(Days, coinValue, difficulty);
                var probBlock7d = calculateProbBlockNDays(Days, coinValue, difficulty, 7);
                var probBlock31d = calculateProbBlockNDays(Days, coinValue, difficulty, 31);
                var probBlock90d = calculateProbBlockNDays(Days, coinValue, difficulty, 90);
                var probBlockYear = calculateProbBlockNDays(Days, coinValue, difficulty, 365);
                document.getElementById('probBlockToday').innerHTML = toFixed(probBlockToday * 100, 6) + '%';
                document.getElementById('probBlock7d').innerHTML = toFixed(probBlock7d * 100, 6) + '%';
                document.getElementById('probBlock31d').innerHTML = toFixed(probBlock31d * 100, 6) + '%';
                document.getElementById('probBlock90d').innerHTML = toFixed(probBlock90d * 100, 6) + '%';
                document.getElementById('probBlockYear').innerHTML = toFixed(probBlockYear * 100, 6) + '%';
                // Rewards
                var rewardNextToday = calculateReward(parseFloat(Days) 1, coinValue);
                var rewardBlock7d = calculateReward(parseFloat(Days) + 7, coinValue);
                var rewardBlock31d = calculateReward(parseFloat(Days) + 31, coinValue);
                var rewardBlock90d = calculateReward(parseFloat(Days) + 90, coinValue);
                var rewardBlockYear = calculateReward(parseFloat(Days) + 365, coinValue);
                document.getElementById('rewardNextToday').innerHTML = toFixed(rewardNextToday, 2) + ' PHR';
                document.getElementById('rewardBlock7d').innerHTML = toFixed(rewardBlock7d, 2) + ' PHR';
                document.getElementById('rewardBlock31d').innerHTML = toFixed(rewardBlock31d, 2) + ' PHR';
                document.getElementById('rewardBlock90d').innerHTML = toFixed(rewardBlock90d, 2) + ' PHR';
                document.getElementById('rewardBlockYear').innerHTML = toFixed(rewardBlockYear, 2) + ' PHR';
            };
            var translate_page = function(lang) {
                var id;
                var dict;
                if (lang === "undefined") {
                    lang = "en";
                }
                dict = translations[lang];
                for (id in dict) {
                    if (document.getElementById(id)) {
                        if (document.getElementById(id).value) {
                            document.getElementById(id).value = dict[id];
                        } else {
                            document.getElementById(id).innerHTML = dict[id];
                        }
                    }
                }
            };
            translate_page();
            // Calculate the POS reward dynamically, without having to press a button
            var coinValueInput = document.querySelector('#NumberOfCoinsStart');
            var daysInput = document.querySelector('#AgeOfTransaction');
            var difficultyInput = document.querySelector('#POSDifficulty');
            // Reward is calculated when typing or when the input loses focus
            coinValueInput.addEventListener('keyup', run);
            coinValueInput.addEventListener('change', run);
            daysInput.addEventListener('keyup', run);
            daysInput.addEventListener('change', run);
            difficultyInput.addEventListener('keyup', run);
            difficultyInput.addEventListener('change', run);
            // Because it runs dynamically, it should run at least once initially
            run();
            // Dynamically pull the current POS difficulty using peerchain's api and YQL to bypass cross-origin-request restrictions.
	    // to do - add curecoin api
            $.ajax({
                url: "http://query.yahooapis.com/v1/public/yql",
                jsonp: "callback",
                dataType: "jsonp",
                data: {
                    q: "select * from json where url=\"http://peerchain.net/api/network/last\"",
                    format: "json"
                },
                success: function( response ) {
                    difficultyInput.value = response.query.results.json.pos_difficulty;
                    run();
                }
            });
        </script>
</html>
